<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pacman Party Map</title>

    <!-- get Leaflet, the map library -->
    <!-- link rel="stylesheet" href="static/css/leaflet.css" /-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css">
    <!-- script src="static/js/leaflet.js"></script>
    
    <!-- get Leaflet easy buttons -->
    <link rel="stylesheet" href="static/css/easy-button.css">

    <!-- get Leaflet awesome markers -->
    <link rel="stylesheet" href="static/css/leaflet.awesome-markers.css">

    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

    <!-- pokemon fantasy -->
    <link rel="stylesheet" href="static/css/sprites.css">
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
        }
    </style>
</head>
<body>

<div id="map"></div>
<!-- font awesome hell yeah-->
<script src="https://use.fontawesome.com/697ebb27cd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
<script src="static/js/easy-button.js"></script>
<script src="static/js/leaflet.awesome-markers.js"></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="static/js/jquery.color.min.js"></script>

<script>
    var flaskData = {{ flaskData|tojson|safe }};
    console.log(flaskData);
    console.log(flaskData.racers[0]);

    // helper to handle objects
    function cloneAsObject(obj) {
        if (obj === null || !(obj instanceof Object)) {
            return obj;
        }
        var temp = (obj instanceof Array) ? [] : {};
        // ReSharper disable once MissingHasOwnPropertyInForeach
        for (var key in obj) {
            temp[key] = cloneAsObject(obj[key]);
        }
        return temp;
    }

    function guid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        });
    }

    var transitionDefaults = {
        duration: 400,
        easing: ''
    };


    // enable vibration support
    navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;


    // Support TLS-specific URLs, when appropriate.
    if (window.location.protocol == "https:") {
        var ws_scheme = "wss://";
    } else {
        var ws_scheme = "ws://"
    };

    var socket = io();
    socket.on('connect', function() {
       socket.emit('derp event', {data: 'i am connecting hell yeah'});
       console.log("Websockets ready - connected");
    });
    console.log("Websockets initialized");

    // create map
    var map = L.map('map',
            {
{#                dragging: false,     // disable dragging the map#}
{#                touchZoom: false,    // disable zooming on mobile#}
                // scrollWheelZoom: false,   // but not on PC
                doubleClickZoom: false,   // zoom on center, wherever you click
                fullscreenControl: true,
            }
    );

    // create tiles with colors
    // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
    //    maxZoom: 18,
    //    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
    //        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
    //        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    //    id: 'mapbox.streets'
    //}).addTo(map);

    // tiles alternative

    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
        maxZoom: 18,
        id: 'carto.light'
    }).addTo(map);
    console.log("Leaflet Map ready");


    //////////////////////
    //  MARKERS

    // Prepare markers to use FontAwesome
    L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

    // set default position
    var defaultPos = L.latLng(50.98, 3.755);


    // put a marker for each Racer
    var markers = {};

    function addRacerMarker(racer) {
        console.log("Racer - "+racer.name+" "+racer.lat+" "+racer.lng);
        if (! racer.color)
            racer.color = 'black';
        markers[racer.name] = L.marker([racer.lat, racer.lng], {    // TODO: subclass
            icon: L.AwesomeMarkers.icon({
                icon: racer.icon,
                markerColor: racer.color,
            }),
{#            icon: L.divIcon({className: "pok001", html:'<div class="pok001"></div>', iconAnchor:[40,40]}),#}
            title: racer.name,
            draggable: true,
            zIndexOffset: 100
        }).on('dragend', function (e) {
            var pos = e.target.getLatLng();
            var title = e.target.options.title;
            if (title == flaskData.username){
                mainRange.setLatLng(pos);
                mainUserTrack.push(pos);
            }
            //storeLocation(title, pos);
            pushMarkerLocation(e.target);
        }).on('click', function (e) {
            e.target.unbindPopup();
            e.target.bindPopup(e.target.options.title).openPopup();
        }).addTo(map);
    }

    for (var i = 0 ; i < flaskData.racers.length; i++) {
        var racer = flaskData.racers[i];
        addRacerMarker(racer);
    }

    // bind to main Racer
    var mainUserMarker = markers[flaskData.username];
    var mainUserTeamColor = flaskData.racers[0].color;
    console.log('We are team '+mainUserTeamColor)
    mainUserMarker.setZIndexOffset(200); // put on top
    var mainRange = L.circle(
            mainUserMarker.getLatLng(), 5,
            { interactive: false,
                stroke: true,
                color: '#B40404',
                weight: 1
            }
    ).addTo(map);
    mainUserMarker.on('move', function(e) {
        mainRange.setLatLng(e.latlng);
    })
    console.log("Markers ready");


    function pushMainLocation (){
        pushMarkerLocation(mainUserMarker);
    }

    function pushMarkerLocation (marker){
        var pos = marker.getLatLng()
        var data = {name:marker.options.title, lat: pos.lat, lng: pos.lng};
        console.log('Outbox: '+JSON.stringify(data));
        socket.emit('move marker', data);
    }


    ////////////////////////
    //  BUTTONS

    // add button that searches your location
    L.easyButton({
        states : [
            {
                stateName: 'locator-disabled',
                icon: 'fa-crosshairs',
                onClick: function (control) {
                    mainUserMarker.bindPopup("Enabled Locator").openPopup();

                    console.log("Start using Leaflet Location");
                    map.locate({
                        watch: true,                // keep tracking
                        enableHighAccuracy: true,   // enable GPS
                        setView: true,              // center the viewport
                        maxZoom: 17,                // zoom to 15 max
                        timeout: 30000
                    });
                    control.state('locator-enabled');
                }
            },
            {
                stateName: 'locator-enabled',
                icon: 'fa-times',
                onClick: function (control) {
                    mainUserMarker.bindPopup("Disabled Locator").openPopup();

                    console.log("Stop using Leaflet Location");
                    map.stopLocate();
                    control.state('locator-disabled');
                }
            }
        ]}).addTo(map);





{#    // add button that sends your location#}
{#    L.easyButton('fa-star', storeMainLocation).addTo(map);#}


    ///////////////////////////////////
    /// BOMBS AWAAAAY
    //-------------------------------//

    function setupBombMode(){
        //mainUserMarker.bindPopup("Enabled Bomb Mode").openPopup();
        mainRange.setRadius(100);
        mainRange.setStyle({
            color: '#2E2E2E',
            weight: 3
        });
        map.dragging.disable();
        map.touchZoom.disable();
    }

    function teardownBombMode(){
        //mainUserMarker.bindPopup("Disabled Bomb Mode").openPopup();
        mainRange.setRadius(5);
        mainRange.setStyle({
            color: '#B40404',
            weight: 1
        });
        map.off('click');
        map.dragging.enable();
        map.touchZoom.enable();
    }

    bombbutton = L.easyButton({
        states : [
            {
                stateName: 'bombmode-off',
                icon: 'fa-bomb',
                onClick: function (control) {
                    setupBombMode()
                    control.state('bombmode-on');
                    map.once('click', function dropBomb(e) {
                        console.log('Dropped a BOMB muhahaha');
                        var pos = e.latlng;
                        data = {lat: pos.lat, lng: pos.lng};
                        socket.emit('add bomb', JSON.stringify(data));
                        teardownBombMode();
                        control.state('bombmode-off');
                    });
                }
            },
            {
                stateName: 'bombmode-on',
                icon: 'fa-times',
                onClick: function (control) {
                    teardownBombMode()
                    control.state('bombmode-off');
                }
            }
        ]}).addTo(map);

    function addBombMarker(json) {
        if (! json.pos) {
            var pos = [json.lat, json.lng];
        }
        var bomb = L.marker(pos, {
            icon: L.AwesomeMarkers.icon({
                icon: 'bomb',
                markerColor: 'black',  //json.team
            })
        }).addTo(map);
        bomb.bindPopup("BOOM");
        markers[json.id] = bomb;
    }

    socket.on('bomb added', function(json) {
        console.log("Inbox received:  B+");
        console.log("Inbox unpack..: "+json.lat+" "+json.lng);
        var marker = markers[json.id];
        if (!marker)
            addBombMarker(json);
        else
            console.log('.. but we already had that marker')
    });

    socket.on('bomb exploded', function(json) {
        console.log("Inbox received: BOOM");
        console.log("Inbox unpack..: "+json.lat+" "+json.lng+" "+json.id);
        var marker = markers[json.id];
        if (marker) {
            console.log("You and I, we knew this was coming");
            map.removeLayer(marker);
            delete markers[json.id];

        } else {
            console.log('Oh... what was that');
        }
        var radius = 10;
        console.log('explode at pos');
        var pos = [json.lat, json.lng];
        console.log('create icon');


        var explosionIcon = L.divIcon({
            iconSize: [30, 30],
            iconAnchor: [10, 10],
            popupAnchor: [10, 0],
            shadowSize: [0, 0],
            className: 'explosion-icon '+json.id,
        });

        console.log('create explosion marker');
{#        var explosion = L.marker(pos, {icon: explosionIcon});#}
{#        // TODO: animated L.circle would be much better...#}
{#        console.log('create explosion add trigger');#}
{#        explosion.on('add', function(e){#}
{##}
{#            // actually this one should be animated ...#}
{#            var damageRange = L.circle(#}
{#                    pos, 100, { interactive: false,#}
{#                                stroke: true,#}
{#                                color: '#2E2E2E',#}
{#                                weight: 3#}
{#                              }#}
{#            ).addTo(map);#}
{##}
{#            console.log('fetch explosion icon');#}
{#            $('.'+json.id)#}
{#            .css({#}
{#                borderRadius: '50%',#}
{#                opacity: '0.8',#}
{#                backgroundColor: '#2E2E2E',#}
{#                boxShadow: '0px 0px 8px orange'#}
{#            })#}
{#            .delay(700)#}
{#            .animate({#}
{#                width: '50px',#}
{#                height: '50px',#}
{#                marginLeft: '-25px',#}
{#                marginTop: '-25px',#}
{#                backgroundColor: '#FE9A2E'#}
{#            }, 600)#}
{#            .animate({#}
{#                width: '30px',#}
{#                height: '30px',#}
{#                marginLeft: '-15x',#}
{#                marginTop: '-15px',#}
{#                backgroundColor: '#B40404',  // red#}
{#            }, 600)#}
{#            .animate({#}
{#                width: '50px',#}
{#                height: '50px',#}
{#                marginLeft: '-25px',#}
{#                marginTop: '-25px',#}
{#                backgroundColor: '#2E2E2E', // darkgrey#}
{#            }, 1000)#}
{#            .animate({#}
{#                opacity: '0',#}
{#            }, 3000, function () {#}
{#                map.removeLayer(explosion);#}
{#                map.removeLayer(damageRange);#}
{#            });#}
{#        });#}
{#        explosion.addTo(map);#}
        var damageRange = L.circle(
                pos, 10,
                {
                    interactive: false,
                    stroke: true,
                    color: '#2E2E2E',
                    fillOpacity: 0.6,
                    weight: 3,
                }
        ).addTo(map);
        var radius = 10;

        setTimeout( function(){
            var id = setInterval(function(){
                radius += 7;
                if (radius < 100) {
                    damageRange.setRadius(radius);
                } else if (radius > 600) {
                    map.removeLayer(damageRange);
                    clearInterval(id);
                }
            }, 40);
        }, 10);

        var audio = new Audio('static/sound/bomb.mp3');
        audio.play();
    });

{#    //////////////////#}
    // SHOW TRACK button

    var mainUserTrack = [];
    var mainUserTrackPolyLine = L.polyline(mainUserMarker.getLatLng()).addTo(map);
    L.easyButton('fa-bolt', function () {
        mainUserTrackPolyLine.setLatLngs(mainUserTrack);
        mainUserMarker.bindPopup("Show track of this session").openPopup();
        if (navigator.vibrate) {
            // vibration API supported
            // vibrate twice
            navigator.vibrate([100, 100, 100]);
        }
    }).addTo(map);
    console.log("AwesomeButtons ready");

    /////////////////////
    // prepare leaflet map.locate callback functions

    var prevMainPos = 0;
    var prevTime = 0;
    var pushReady = true;
    function onLocationFound(e) {
{#        console.log("Found your location hurray");#}
        var radius = e.accuracy / 2;
        mainUserMarker.setLatLng(e.latlng);
                //.bindPopup("You are within " + radius + " meters from this point").openPopup();
        mainUserTrack.push(e.latlng);
        //mainRange.setRadius(radius);
        if (e.latlng == prevMainPos || e.timestamp < prevTime + 5000){
            return
        } else {
            pushMainLocation();
            prevMainPos = e.latlng;
            prevTime = e.timestamp;
        }
    }

    function onLocationError(e) {
        // console.log("Sorry no location found");
        //map.setView(defaultPos, 13);
        setFreeGeoIP();
        // alert(e.message);
    }

    function setFreeGeoIP() {
        // use jquery ajax call to lookup the geolocation based on your ipaddress
        // max 10k requests per hour
        $.getJSON("https://freegeoip.net/json/",
            // when AJAX call is successful, run the following function
            function (data) {
                console.log("FreeGeoIP - "+data);
                console.log("FreeGeoIP setting mainMarker location");
                var pos = L.latLng(data.latitude, data.longitude);
                // add a marker on the location of the resolved GeoIP
                mainUserMarker.setLatLng(pos).bindPopup("You are somewhere here").openPopup();
                mainRange.setRadius(40);
                pushMarkerLocation(mainUserMarker);
                // update the map
                map.setView(pos, 14);
            }
        );
    }

    // connect location events to callback functions
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    console.log("Leaflet location callbacks ready.. setView to main marker");


{#/////////////////////////////////////////#}
{#    NOT USED                  #}
    {#  #}

    {% if False %}

    // add the pokebomber button
    // this should end up in
    var nomNodes = {};
    var nomWays = {};
    var plotNomNodeCounter = 0;
    var plotNomNodes = [];
    var plotNomLastPos = mainUserMarker.getLatLng();
    var noms = L.featureGroup([]).addTo(map);
    var nomIcon = L.AwesomeMarkers.icon({icon:'diamond', markerColor:'orange'});

    L.easyButton('fa-coffee', function () {
        var range = 160;
        var pos = mainUserMarker.getLatLng();
        mainUserMarker.bindPopup("Drop da pokebomb!").openPopup();

        var query = 'https://overpass-api.de/api/interpreter?' +
                'data=[out:json][timeout:10];' +
                '(way(around:'+range+','+pos.lat+','+pos.lng+');>;);' +
                'out;';
        console.log(query);
        $.getJSON(query, function(data) {
            var d = cloneAsObject(data);
            var nodes = d.elements;
            console.log('Coffee got '+ nodes.length + ' nodes');
            for (var i=0 ; i < nodes.length; i++) {
                var node = nodes[i];

                if (node.type == 'node') {
                    var pos = L.latLng([node.lat, node.lon]);
                    nomNodes[node.id] = pos;
                } else if (node.type == 'way'){
{#                    console.log('Coffee got a way!');#}
                    var waynodes = cloneAsObject(node['nodes']);
                    var wayarray = [];
                    for (var j=0; j < waynodes.length; j++) {
                        // get the node with this id
                        nodeID = waynodes[j];
                        nd = nomNodes[nodeID];
                        wayarray.push(nd);
                        plotNomNodes.push(nodeID);
                    }
                    nomWays[node.id] = wayarray;
                }
            }
            plotNomLastPos = mainUserMarker.getLatLng();
{#            console.log('COFFEE end - '+plotNomNodes);#}
        });
    }).addTo(map);

    function isValidNom(pos){
        var minRange = 80;
        var maxRange = 500;

        if (pos == null)
            return false;
        // too far away
        if (pos.distanceTo(mainUserMarker.getLatLng()) > maxRange)
            return false;
        // too close to other existing noms
        if (noms.getLayers().some( function (layer, i){
            //console.log('Distance '+pos+' to '+layer.getLatLng()+' is '+pos.distanceTo(layer.getLatLng()));
            return pos.distanceTo(layer.getLatLng()) < minRange;
        }))
            return false;
        return true;
    }

    function getRandomInt(min, max) {
       return Math.floor(Math.random() * (max - min + 1)) + min;
    }


    class PokeMarker extends L.marker {
        constructor(pos, index){
            // add a blurry marker that will become clear when you click it
            var blurryClass = 'pok pok'+('00'+(index)).slice(-3)+' blurrypok';
            var nearbyClass = 'pok pok'+('00'+(index)).slice(-3)+' nearbypok';
            var blurryHTML = '<div class="' + blurryClass + '"></div>';
            var clearHTML = '<div class="' + nearbyClass + '"></div>';
            var icon = L.divIcon({
                          className: blurryClass,
                          html: blurryHTML,
                          iconAnchor: [40,40]
            });
            super(pos, {
                title: blurryClass,
                icon: icon
            });
            this.icon = icon;
            this.pokIndex = nearbyClass;
            this.on('mousedown', function(e) {
                this.options.zIndexOffset = 100;
                console.log('MSDN '+this.icon.options.html);
                console.log('MSDN '+this.icon.options.className);
{#                this.icon.options.html = clearHTML;#}
{#                this.icon.options.className = clearClass;#}
                console.log($('.pok .pok'+('00'+(index)).slice(-3)));
                $('.pok .pok'+('00'+(index)).slice(-3)).addClass('nearbypok').removeClass('blurrypok');
                console.log($('.pok .pok'+('00'+(index)).slice(-3)));

            }).on('mouseup', function(e) {
                this.options.zIndexOffset = 10;
                console.log('MSUP '+this.icon.options.html);
                console.log('MSUP '+this.icon.options.className);
                console.log($('.pok .pok'+('00'+(index)).slice(-3)));
                $('.pok .pok'+('00'+(index)).slice(-3)).addClass('blurrypok').removeClass('nearbypok');
                console.log($('.pok .pok'+('00'+(index)).slice(-3)));
{#                this.icon.options.html = blurryHTML;#}
{#                this.icon.options.className = blurryClass;#}
            });

        }

    }

    function addNomNode() {
        var nomNodeReady = false;
        // console.log('yawn '+plotNomNodeCounter+" "+plotNomNodes.length);
        while (!nomNodeReady && plotNomNodeCounter < plotNomNodes.length) {
            var nodeID = plotNomNodes[plotNomNodeCounter];
            var pos = nomNodes[nodeID];
            // make sure the new point is not too close to the points we already have / nor too far
            while (plotNomNodeCounter < plotNomNodes.length && !isValidNom(pos)) {
                console.log('Skip NOM nr ' + plotNomNodeCounter);
                // get next nomNode
                nodeID = plotNomNodes[++plotNomNodeCounter];
                pos = nomNodes[nodeID];
            }
            if (!pos)
                break;
            // the current point is not too close to the current noms
            noms.addLayer( new PokeMarker(pos, getRandomInt(1,151)));
            nomNodeReady = true;
            plotNomLastPos = pos;
            console.log('Put NOM at ' + pos+ ' ' + pokIndex);
            if (navigator.vibrate) {
                // vibration API supported
                // vibrate once
                navigator.vibrate([100]);
            }
        }
        plotNomNodeCounter++;
    }

    var nomTimer = setInterval(addNomNode, 300);

    {% endif %}


    // TEAM SCORE BOARD

    var teamScore = L.control();

    teamScore.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "teamScore"
        this.update();
        return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    teamScore.update = function (props) {
        var html = '<h4>Team score</h4>'
        if (props) {
            for (var color in props.team) {
                html += '<i style="background:' + color + '"></i> ' + props.team[color] + ' points<br>';
            }
        }
        this._div.innerHTML = html;
    };



    teamScore.addTo(map);


    function resetScore(e) {
        teamScore.update();
    }

    //

    map.setView(mainUserMarker.getLatLng(), 16);

    {# HOME: 50.9829401,3.7375336, 15 #}
    // now locate the user
{#    map.locate({#}
{#        watch: true,                // keep tracking#}
{#        enableHighAccuracy: true,   // enable GPS#}
{#        setView: true,              // center the viewport#}
{#        maxZoom: 16                 // zoom to 15 max#}
{#    });#}

    socket.on('marker moved', function(data) {
        console.log("Inbox received:  MM");
        console.log("Inbox unpack..: "+data.name+" "+data.lat+" "+data.lng);
        var marker = markers[data.name];
        if (marker) {
            marker.setLatLng(L.latLng(data.lat, data.lng));
        }
    });

    socket.on('marker added', function(data) {
        console.log("Inbox received:  M+");
        console.log("Inbox unpack..: "+data.name+" "+data.lat+" "+data.lng);
        var marker = markers[data.name];
        if (!marker)
            addRacerMarker(data);
        else
            console.log('.. but we already had that marker')
    });

    socket.on('marker removed', function(data) {
        console.log("Inbox received:  M-");
        console.log("Inbox unpack..: "+data.name);
        var marker = markers[data.name];
        if (marker) {
            map.removeLayer(marker);
            delete markers[data.name];
        } else {
            console.log('.. but we don\'t know that marker?')
        }

    });

    socket.on('new score', function(data) {
        console.log("Inbox received:  T+");
        console.log("Inbox unpack..: "+data.team[mainUserTeamColor]+" "+data.individual[flaskData.username]);
        teamScore.update(data);
    });

</script>
</body>
</html>
