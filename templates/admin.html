<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Battle Royale Map</title>

    <!-- get Leaflet, the map library -->
    <!-- link rel="stylesheet" href="static/css/leaflet.css" /-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css">
    <!-- script src="static/js/leaflet.js"></script>

    <!-- get Leaflet easy buttons -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/easy-button.css') }}">

    <!-- get Leaflet awesome markers -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.awesome-markers.css') }}">

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<!-- font awesome hell yeah-->
<script src="https://use.fontawesome.com/697ebb27cd.js"></link>

<script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/easy-button.js') }}"></script>
<script src="{{ url_for('static', filename='js/leaflet.awesome-markers.js') }}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<script>
    // create map
    var map = L.map('map',
            {
                dragging: true,     // disable dragging the map
                touchZoom: true,    // disable zooming on mobile
                // scrollWheelZoom: false,   // but not on PC
                doubleClickZoom: false,   // zoom on center, wherever you click
            }
    );

    // create tiles with colors
    // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
    //    maxZoom: 18,
    //    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
    //        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
    //        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    //    id: 'mapbox.streets'
    //}).addTo(map);

    // tiles alternative

    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
        maxZoom: 18,
        id: 'carto.light'
    }).addTo(map);


    //////////////////////
    //  MARKERS

    // Prepare markers to use FontAwesome
    L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

    // set default position
    var defaultPos = L.latLng(50.98, 3.755);

    // put database markers
    {% for racer in racers %}
        {% if racer.name == username %}
            // create the central main marker
            var mainUserMarker = L.marker([{{ racer.x }}, {{ racer.y }}], {
            icon: L.AwesomeMarkers.icon({icon: 'user-secret', markerColor: 'red'}),
            title: "{{ username }}",
            {% else %}
            // no need to save the others now
            L.marker([{{ racer.x }}, {{ racer.y }}], {
            icon: L.AwesomeMarkers.icon({icon: '{{ racer.name }}', markerColor: 'blue'}),
            title: "{{ racer.name }}",
        {% endif %}
    draggable: true
    }).on('dragend', function (e) {
        var pos = e.target.getLatLng();
        var title = e.target.options.title;
        mainRange.setLatLng(pos).setRadius(100);
        pushLocation(title, pos);
    }).addTo(map);
    {% endfor %}

    var mainRange = L.circle(mainUserMarker.getLatLng(), 100).addTo(map);

    var manymarkers = [];

    ////////////////////////
    //  BUTTONS

    // add button that searches your location
    L.easyButton('fa-crosshairs', function () {
        map.locate({setView: true, maxZoom: 16});
        for (var i = 0; i < manymarkers.length; i++) {
            console.log("Marker at " + manymarkers[i].latlng);
        }
    }).addTo(map);

    // add button that goes to
    L.easyButton('fa-coffee', function () {
        map.setView(mainUserMarker.getLatLng(), 13);
        L.polyline({{ positions }}).addTo(map);
    }).addTo(map);

    // send location info to server
    function pushLocation(title, pos) {
        var data = title + ' ' + pos.lat + ' ' + pos.lng;
        console.log("Stop Drag at " + pos + ".. now post this: " + data);
        $.post('moveit',
                data,
                function (r) {
                    console.log('Post Drag success! ' + r)
                },
                'text');
    }

    ///////////////////////
    // Server Side Events (flask_sse)
    {#    var source = new EventSource("{{ url_for('sse.stream') }}");#}
    {#    source.addEventListener('myevent', function (e) {#}
    {#        var data = JSON.parse(e.data);#}
    {#        // handle event#}
    {#        mainUserMarker.bindPopup(data['message']).openPopup()#}
    {#    }, false);#}


    /////////////////////
    // prepare location callback functions
    function moveMainMarker(pos, radius) {
        mainUserMarker.setLatLng(pos).bindPopup("You are within " + radius + " meters from this point").openPopup();
        mainRange.setLatLng(pos).setRadius(radius);
    }

    function onLocationFound(e) {
        console.log("Found your location hurray");
        var radius = e.accuracy / 2;
        pushLocation("{{ username }}", e.latlng);
        moveMainMarker(e.latlng, e.radius)
    }

    function onLocationError(e) {
        console.log("Sorry no location found");
        map.setView(defaultPos, 13);
        //getFreeGeoIP();
        // alert(e.message);
    }

    function addMarker(e) {
        console.log("Adding a marker at %s" % e.latlng);
        var marker = L.marker(e.latlng).addTo(map);
        manymarkers.push(marker);
    }
    //map.on('click', addMarker);

    // connect location events to callback functions
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    // now locate the user
    //map.locate({setView: true, maxZoom: 16});
    map.setView(defaultPos, 13);


    ////////////////////
    // geolocation
    var prevCoords = 0;
    var prevTime = 0;
    var pushReady = true;
    // help function
    function cloneAsObject(obj) {
        if (obj === null || !(obj instanceof Object)) {
            return obj;
        }
        var temp = (obj instanceof Array) ? [] : {};
        // ReSharper disable once MissingHasOwnPropertyInForeach
        for (var key in obj) {
            temp[key] = cloneAsObject(obj[key]);
        }
        return temp;
    }

    if (navigator.geolocation) {
        var options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 200,
        };
        navigator.geolocation.watchPosition(
            function success(pos) {

                var newTime = pos.timestamp;
                var crd = pos.coords;
                // if the player moved, update to the server.

                var newCoords = JSON.stringify(cloneAsObject(crd))
                var data = JSON.stringify(cloneAsObject(pos));
                // do not compare with data as the timestamp changes.......
                if ((newCoords != prevCoords) && (newTime > prevTime + 5000) && pushReady) {
                    console.log("WatchPos " + crd.latitude + " " + crd.longitude);
                    console.log("Pushing " + data);
                    if (!$.isEmptyObject(data)) {
                        pushReady = false;
                        $.post('/addpos', data)
                                .always(function () {
                                    pushReady = true;
                                });
                    }
                    // update previous coordinates
                    prevCoords = newCoords;
                    prevTime = newTime;
                }

            },
            function error(err) {
                //
            }, options
        )
    }
</script>
</body>
</html>